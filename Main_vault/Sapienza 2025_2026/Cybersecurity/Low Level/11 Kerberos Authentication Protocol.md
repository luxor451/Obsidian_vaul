**Tags:** #Cybersecurity #LowLevel #Cryptography #Authentication #Kerberos #NetworkSecurity #SSO #KDC

---

# 1. Introduction to Kerberos

## Definition
Kerberos is a network authentication protocol designed to provide strong authentication for client/server applications by using secret-key cryptography.
* **Goal:** Allow nodes communicating over a non-secure network to prove their identity to one another in a secure manner.
* **Origin:** Developed by MIT (Project Athena).
* **Name:** Derived from Cerberus, the three-headed dog guarding Hades (symbolizing the three heads of the protocol: Client, Server, and KDC).
* **Standard:** Currently defined in RFC 4120 (Version 5).

## Key Features
1.  **Mutual Authentication:** The client authenticates the server, and the server authenticates the client.
2.  **Single Sign-On (SSO):** Users log in once and access multiple services without re-entering credentials.
3.  **Trusted Third Party:** Relies on a centralized authentication server called the **Key Distribution Center (KDC)**.
4.  **Symmetric Cryptography:** Uses shared secret keys (though modern versions support public key extensions via PKINIT).
5.  **Ticket-Based:** Uses encrypted data packets called "tickets" to transmit identity and session keys.

---

# 2. Core Concepts

## The KDC (Key Distribution Center)
The trusted third party that holds a database of all principals and their secret keys. It is logically divided into two parts:
1.  **Authentication Server (AS):** Verifies users during login and issues a Ticket Granting Ticket (TGT).
2.  **Ticket Granting Server (TGS):** Issues specific service tickets to users who present a valid TGT.

## Principals
Any entity (user or service) recognized by the system.
* **Naming Convention:** `primary/instance@REALM`
* **Examples:**
    * User: `alice@WONDERLAND`
    * Service: `ftp/fileserver.wonderland@WONDERLAND`
    * Admin instance: `alice/admin@WONDERLAND`

## Keys
1.  **Master Keys (Long-term):**
    * Shared between the Principal and the KDC.
    * For users: Derived from their password (hash).
    * For services: A random key stored in a keytab file.
2.  **Session Keys (Short-term):**
    * Temporary keys generated by the KDC for a specific conversation between two parties.
    * Valid only for the duration of the ticket.

## Tickets
A structure used to pass the identity of a client to a server safely.
* **Structure:** Encrypted with the Server's secret key ($K_{Server}$).
* **Content:**
    * Identity of the Client ($A$)
    * Session Key ($K_{Session}$)
    * Validity Period (Start/End time)
    * Flags (Forwardable, Proxy, etc.)

---

# 3. The Kerberos Protocol Flow

The protocol consists of three distinct exchanges.

## Phase 1: The Authentication Service (AS) Exchange
**Goal:** Login. The user authenticates to the KDC and gets a Ticket Granting Ticket (TGT).

1.  **AS_REQ (Client $\to$ KDC):**
    * "I am Alice, and I want a TGT."
    * Message: $ID_{Alice}, ID_{TGS}, Nonce_1$
    * Sent in cleartext (no password sent over the network).

2.  **AS_REP (KDC $\to$ Client):**
    * The KDC checks if Alice exists.
    * Generates a Session Key ($K_{A-TGS}$).
    * Creates the **TGT**: $\{Alice, K_{A-TGS}, \text{Validity}\}_{K_{TGS}}$ (Encrypted with TGS key).
    * Creates the response for Alice: $\{K_{A-TGS}, ID_{TGS}, \text{Validity}, Nonce_1\}_{K_{Alice}}$ (Encrypted with Alice's master key).

3.  **Client Processing:**
    * Alice decrypts the response using her password hash ($K_{Alice}$).
    * She extracts the session key $K_{A-TGS}$ and the TGT.
    * *Note:* She cannot decrypt the TGT itself.

## Phase 2: The Ticket Granting Service (TGS) Exchange
**Goal:** Get a ticket for a specific service (e.g., File Server) using the TGT.

1.  **TGS_REQ (Client $\to$ KDC/TGS):**
    * "I have a TGT, and I want to talk to Bob (File Server)."
    * Message:
        * **TGT:** $\{Alice, K_{A-TGS}, \dots\}_{K_{TGS}}$
        * **Authenticator:** $\{Alice, Timestamp\}_{K_{A-TGS}}$ (Proves she owns the session key).
        * $ID_{Bob}, Nonce_2$

2.  **TGS_REP (KDC/TGS $\to$ Client):**
    * KDC decrypts TGT to get $K_{A-TGS}$.
    * Decrypts Authenticator to verify Alice's identity and freshness (Timestamp).
    * Generates a new Session Key ($K_{A-B}$).
    * Creates **Service Ticket**: $\{Alice, K_{A-B}, \text{Validity}\}_{K_{Bob}}$ (Encrypted with Bob's key).
    * Sends response: $\{K_{A-B}, ID_{Bob}, \text{Validity}, Nonce_2\}_{K_{A-TGS}}$.

## Phase 3: The Client/Server (CS) Exchange
**Goal:** Access the service.

1.  **AP_REQ (Client $\to$ Server):**
    * "Here is my ticket and proof of identity."
    * Message:
        * **Service Ticket:** $\{Alice, K_{A-B}, \dots\}_{K_{Bob}}$
        * **New Authenticator:** $\{Alice, Timestamp\}_{K_{A-B}}$

2.  **AP_REP (Server $\to$ Client) [Optional Mutual Auth]:**
    * Server decrypts Ticket to get $K_{A-B}$.
    * Decrypts Authenticator to verify Alice and freshness.
    * Message: $\{Timestamp + 1\}_{K_{A-B}}$
    * *Purpose:* Proves to Alice that the server is real (only the real Bob could decrypt the ticket to get the session key).

---

# 4. Realms and Hierarchy

## Definition
A **Realm** is an administrative domain in Kerberos (like a Windows Domain).
* All principals in a realm are registered with the same KDC.
* Case-sensitive (usually UPPERCASE).

## Cross-Realm Authentication
How can Alice@REALM1 access a service in REALM2?
1.  **Trust Relationship:** The KDCs of REALM1 and REALM2 must share a secret key (Inter-realm key).
2.  **Process:**
    * Alice asks her KDC (KDC1) for a ticket to KDC2.
    * KDC1 issues a "Referral Ticket" encrypted with the inter-realm key.
    * Alice presents this ticket to KDC2.
    * KDC2 issues the Service Ticket for the local service in REALM2.

---

# 5. Evolution: Version 4 vs Version 5

## Kerberos Version 4 (Limitations)
* **Encryption:** Only supported DES (56-bit), which is now insecure.
* **Network:** Relied heavily on IP addresses (issues with NAT/DHCP).
* **Lifetime:** Maximum ticket lifetime was fixed ($\approx 21$ hours).
* **Protocol:** Used timestamps heavily for replay protection (strict clock sync required).

## Kerberos Version 5 (Improvements - RFC 4120)
* **Encryption Agility:** Supports AES, Camellia, etc.
* **Flexibility:** Uses ASN.1 encoding for messages, allowing extensions.
* **Delegation:** Allows a server to act on behalf of a user (Forwardable tickets).
* **Life Control:** Renewable tickets, varying lifetimes.
* **Replay Cache:** Improved mechanisms beyond just timestamps.
* **Sub-Session Keys:** Allows negotiating new keys within a session for added security.

---

# 6. Security & Vulnerabilities

## Requirements
* **Clock Synchronization:** Critical. If a client's clock is too far off (usually > 5 minutes) from the KDC, authentication fails (Replay protection).
* **KDC Availability:** The KDC is a Single Point of Failure (SPoF). If it goes down, no one can log in. (Mitigated by secondary KDCs).
* **KDC Security:** The KDC stores all master keys. If compromised, the entire realm is compromised.

## Attacks
* **Offline Password Cracking:** If an attacker captures the AS_REP, they can try to brute-force Alice's password offline (since part of the message is encrypted with her password hash).
* **Pass-the-Ticket:** Capturing a valid TGT or Service Ticket from memory to impersonate a user without knowing their password.
* **Golden Ticket:** If the attacker gets the **KRBTGT** account key (TGS key), they can forge TGTs for any user with infinite validity.