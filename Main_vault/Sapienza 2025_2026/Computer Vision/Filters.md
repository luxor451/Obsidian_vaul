**Tags:** #ComputerVision #ImageFiltering #Convolution #Smoothing #Sharpening #NoiseReduction
![[5-Filters.pdf]]
# Neighbourhood Operations

- Neighbourhood operations simply operate on a larger neighbourhood of pixels than point operations
- Neighbourhoods are mostly a rectangle around a central pixel
- Any size rectangle and any shape filter are possible
- For each pixel in the origin image, the outcome is written on the same location at the target image.
![[2025-10-09-134029_hyprshot.png]]
### Examples
- **Min**: Set the pixel value to the minimum in the neighbourhood
- **Max**: Set the pixel value to the maximum in the neighbourhood
# Spatial Filtering 
![[2025-10-09-134235_hyprshot.png]]
$$e_{procressed} = n \cdot e+ j \cdot a+ k \cdot b + l \cdot c + m \cdot d + o \cdot f + p \cdot g + q \cdot h + r \cdot i$$
> [!NOTE] The above is repeated for every pixel in the original image to generate the filtered image

##### Equation Form
![[2025-10-09-134421_hyprshot.png]]
$$g(x,y) = \sum ^{a}_{s=-a}\sum ^{b}_{t=-b} w(s,t)\cdot f(x+s,y+t)$$
Filtering can be given in equation form as shown above

### Smoothing Spatial Filters
One of the simplest spatial filtering operations we can perform is a smoothing operation
- Simply average all of the pixels in a neighbourhood around a central value
- Especially useful in removing noise from images
- Also useful for highlighting gross detail
##### Simple averaging filter :

| $\frac{1}{9}$     | $\frac{1}{9}$<br> | $\frac{1}{9}$<br> |
| ----------------- | ----------------- | ----------------- |
| $\frac{1}{9}$<br> | $\frac{1}{9}$<br> | $\frac{1}{9}$<br> |
| $\frac{1}{9}$<br> | $\frac{1}{9}$<br> | $\frac{1}{9}$<br> |
Example : 
![[2025-10-09-134746_hyprshot.png]]
$$ \begin{aligned}
e_{new} &= \frac{1}{9} \times 106 + \frac{1}{9} \times 104 + \frac{1}{9} \times 100 \\&+ \frac{1}{9} \times 108 + \frac{1}{9} \times 99 + \frac{1}{9} \times 98\\&+ \frac{1}{9} \times 95 + \frac{1}{9} \times 90 + \frac{1}{9} \times 85 \\ &= 98.333 \\
\end{aligned}
$$
![[2025-10-09-135339_hyprshot.png]]

Top Left is a 500x500 image, it shows averaging with a filter of size 3,5,9,15 and 35

##### Weighted Smoothing Filters

More effective smoothing filters can be generated by allowing different pixels in the neighbourhood different weights in the averaging function 
- Pixels closer to the central pixel are more important
- Often referred to as a *weighted averaging*

| $\frac{1}{16}$ | $\frac{2}{16}$ | $\frac{1}{16}$ |
| -------------- | -------------- | -------------- |
| $\frac{2}{16}$ | $\frac{4}{16}$ | $\frac{2}{16}$ |
| $\frac{1}{16}$ | $\frac{2}{16}$ | $\frac{1}{16}$ |
###### Another Smoothing Example
By smoothing the original image we get rid of lots of the finer detail which leaves only the gross features for thresholding![[2025-10-09-135743_hyprshot.png]]

##### Averaging Filter Vs. Median Filter
![[2025-10-09-135812_hyprshot.png]]
- Filtering is often used to remove noise from images
- Sometimes a median filter works better than an averaging filter
##### Strange Things Happen At The Edges!
At the edges of an image we are *missing pixels* to form a neighbourhood

There are a few approaches to dealing with missing edge pixels:
- Omit missing pixels
	- Only works with some filters
	- Can add extra code and slow down processing
- Pad the image
	- Typically with either all white or all black pixels
- Replicate border pixels
- Truncate the image

##### Correlation & Convolution
The filtering we have been talking about so far is referred to as correlation with the filter itself referred to as the *correlation kernel*

Convolution is a similar operation, with just one subtle difference![[2025-10-09-140127_hyprshot.png]]
$$e_{processed} = v\cdot e + z\cdot a + y\cdot b + x\cdot c + w\cdot d + u\cdot e + t\cdot f + s\cdot g + r\cdot h$$
For symmetric filters it makes no difference

### Sharpening Spatial Filters
Sharpening spatial filters seek to highlight fine detail
- Remove blurring from images
- Highlight edges
Sharpening filters are based on *spatial differentiation*
Differentiation measures the *rate of change* of a function
****
**1st Derivative**
The formula for the 1st derivative of a function(discrete) is as follows: 
$$\frac{\partial{f}}{\partial x} = f(x+1) -f(x)$$Itâ€™s just the difference between subsequent values and measures the rate of change of the function
****
**2nd Derivative**
The formula for the 2nd derivative of a function is as follows:
$$\frac{\partial^{2}{f}}{\partial^{2} x} = f(x+1) + f(x-1) - 2f(x)$$
Simply takes into account the values both before and after the current value

*Using Second Derivatives For Image Enhancement*

- The 2nd derivative is more useful for image enhancement than the 1st derivative
	- Stronger response to fine detail
	- Simpler implementation
	- We will come back to the 1st order derivative later on
- The first sharpening filter we will look at is the *Laplacian*
	- Isotropic
	- One of the simplest sharpening filters
	- We will look at a digital implementation
# The Laplacian
The Laplacian is defined as follows : $$\nabla^{2}f = \frac{\partial^{2}{f}}{\partial^{2} x} + \frac{\partial^{2}{f}}{\partial^{2} y}$$
Where the partial 2st order derivative in the x direction is defined as follows :
$$\frac{\partial^{2}{f}}{\partial^{2} x} = f(x+1,y) + f(x-1,y) - 2f(x,y)$$
And the y directions : $$\frac{\partial^{2}{f}}{\partial^{2} x} = f(x,y+1) + f(x,y-1) - 2f(x,y)$$
Thus The Laplacian can be written : $$\begin{aligned}
\nabla^{2} f &= f(x+1,y) + f(x-1,y)  \\
&+f(x,y+1) + f(x,y-1) \\
&- 4f(x,y)
\end{aligned}
$$
We can easily build a filter based on this :

|  0  |  1  |  0  |
| :-: | :-: | :-: |
|  1  | -4  |  1  |
|  0  |  1  |  0  |

### Applying the Laplacian to an image 
We get a new image that highlights edges and other discontinuities :
![[2025-10-16-172033_hyprshot.png]]

### The result of a Laplacian filtering is not an enhanced image
- We have to do more work in order to get our final image
- Subtract the Laplacian result from the original image to generate our final sharpened enhanced image
$$g = f - \nabla^{2}f$$![[2025-10-16-172229_hyprshot.png]]
**In the final sharpened image edges and fine detail are much more obvious**
### Simplified Image Enhancement
$$g(x,y) = 5\cdot f(x,y) - f(x+1,y) - f(x-1,y) - f(x,y+1) - f(x,y-1)$$

|  0  | -1  |  0  |
| :-: | :-: | :-: |
| -1  |  5  | -1  |
|  0  | -1  |  0  |
### Variants On The Simple Laplacian
There are lots of slightly different versions of the Laplacian that can be used
**Simple Laplacian :**

|  0  |  1  |  0  |
| :-: | :-: | :-: |
|  1  | -4  |  1  |
|  0  |  1  |  0  |
**Variant of Laplacian :**

|  1  |  1  |  1  |
| :-: | :-: | :-: |
|  1  | -8  |  1  |
|  1  |  1  |  1  |

# Unsharp Mask & Highboost Filtering
Using sequence of linear spatial filters in order to get Sharpening effect.
- Blur
- Subtract from original image
- add resulting mask to original image
### Highboost Filtering
![[2025-10-16-172720_hyprshot.png]]
### 1st Derivative Filtering
Implementing 1st derivative filters is difficult in practice

- For a function $f(x, y)$ the gradient of $f$ at coordinates $(x, y)$ is given as the column vector: $$
\begin{align}
    \nabla f = \begin{bmatrix}
           G_{x} \\
           G_{y} \\
         \end{bmatrix}   
&= \begin{bmatrix}
            \frac{\partial f}{\partial x}\\
           \frac{\partial f}{\partial y}
         \end{bmatrix}
  \end{align}
$$
- The magnitude of this vector is given by :  $$\nabla f = \text{mag}(\nabla f) = \sqrt{ G_{x}^{2} + G_{y}^{2}} = \sqrt{\left( \frac{\partial f}{\partial x} \right)^{2} + \left( \frac{\partial f}{\partial y} \right)^{2}  }$$For practical reasons this can be simplified as: $$\nabla f = |G_{x}|+|G_{y}|$$
- There is some debate as to how best to calculate these gradients but we will use: $$
\begin{align}
\nabla f &\approx |(z_{7} + 2z_{8}+z_{9}) - (z_{1}+2z_{2}+z_{3})| \\
&+|(z_{3}+2z_{6}+z_{9}) - (z_{1}+2z_{4}+z_{7})|
\end{align}$$
with 

| $z_{1}$ | $z_{2}$ | $z_{3}$ |
| :-----: | :-----: | :-----: |
| $z_{4}$ | $z_{5}$ | $z_{6}$ |
| $z_{7}$ | $z_{8}$ | $z_{9}$ |
##### Sobel Operators
Based on the previous equations we can derive the **Sobel Operators**

| -1  | -2  | -1  |     |     |     | -1  |  0  |  1  |
| :-: | :-: | :-: | --- | --- | --- | :-: | :-: | :-: |
|  0  |  0  |  0  |     |     |     | -2  |  0  |  2  |
|  1  |  2  |  1  |     |     |     | -1  |  0  |  1  |
>[!NOTE] To filter an image it is filtered using both operators the results of which are added together

![[2025-10-16-174007_hyprshot.png]]Sobel filters are typically used for *[[Egde|edge detection]]*

# 1st & 2nd Derivatives

Comparing the 1st and 2nd derivatives we can conclude the following:
- 1st order derivatives generally produce thicker edges
- 2nd order derivatives have a stronger response to fine detail e.g. thin lines
- 1st order derivatives have stronger response to grey level step
- 2nd order derivatives produce a double response at step changes in grey level

# Combining Spatial Enhancement Methods
Successful image enhancement is typically not achieved using a single operation
- Rather we combine a range of techniques in order to achieve a final result
- This example will focus on enhancing the bone scan ![[2025-10-16-174152_hyprshot.png]]![[2025-10-16-174207_hyprshot.png]]
### Original to Final
 
 ![[2025-10-16-174223_hyprshot.png]]